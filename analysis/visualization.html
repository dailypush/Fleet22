<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet 22 Data Visualization</title>
    <meta name="description" content="Interactive data visualization of Fleet 22 Lake Erie J105 racing sailboat statistics.">
    <meta name="keywords" content="Fleet 22, Lake Erie, J105, data visualization, sailing statistics">
    <meta name="author" content="Fleet 22 Lake Erie">
    <link rel="icon" type="image/png" href="../assets/favicon_io/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="../assets/favicon_io/favicon-32x32.png" sizes="32x32">

    <!-- Open Graph -->
    <meta property="og:title" content="Fleet 22 Data Visualization">
    <meta property="og:description" content="Interactive data visualization of Fleet 22 Lake Erie J105 racing sailboat statistics.">
    <meta property="og:image" content="../images/hero_shot.jpeg">
    <meta property="og:url" content="https://www.fleet22.us/analysis/visualization.html">

    <!-- Allow self-hosted content and CDN resources with proper CSP settings -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; img-src 'self' data:; connect-src 'self'">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/styles.css">
    <style>
        .chart-container {
            padding: 60px 0;
        }
        .chart {
            margin-bottom: 30px;
        }
        .page-header {
            background-color: #007bff;
            color: white;
            padding: 60px 0;
            margin-bottom: 40px;
            text-align: center;
        }
        #allHeatmapsContainer .card {
            margin-bottom: 20px;
        }
        .heatmaps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="https://fleet22.us">Fleet 22 Lake Erie</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../classifieds.html">Classifieds</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../members.html">Members</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../north_americans_2024.html">North Americans 2024</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../news/index.html">News</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../gallery.html">Gallery</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="./visualization.html">Data Visualization</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <header class="page-header">
        <div class="container">
            <h1>Fleet 22 Data Visualization</h1>
            <p class="lead">Interactive charts showcasing our fleet statistics</p>
        </div>
    </header>

    <!-- Chart Section -->
    <section class="chart-container">
        <div class="container">
            <div class="row">
                <div class="col-md-6 chart">
                    <canvas id="fleet22BoatsChart"></canvas>
                </div>
                <div class="col-md-6 chart">
                    <canvas id="sailTagsChart"></canvas>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 chart">
                    <canvas id="boatsWithNamesChart"></canvas>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-4">
                    <h2 class="text-center my-4">Sail Purchase Heatmaps</h2>
                    <p class="text-center mb-4">Select a hull to view its sail purchase history</p>
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-4">
                            <div class="input-group">
                                <label class="input-group-text" for="fleetSelector">Fleet</label>
                                <select id="fleetSelector" class="form-select">
                                    <option selected value="all">All Fleets</option>
                                    <option value="22">Fleet 22 Only</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-4">
                            <div class="input-group">
                                <label class="input-group-text" for="hullSelector">Hull #</label>
                                <select id="hullSelector" class="form-select">
                                    <option selected value="">Choose a hull...</option>
                                    <!-- Hull options will be added dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="showAllHeatmaps">
                                <label class="form-check-label" for="showAllHeatmaps">Show all hulls</label>
                            </div>
                        </div>
                    </div>
                    <div id="selectedHeatmapContainer" class="row justify-content-center">
                        <!-- Selected hull's heatmap will be displayed here -->
                    </div>
                    <div id="allHeatmapsContainer" class="row" style="display: none;">
                        <!-- All hulls' heatmaps will be displayed here when toggled -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Fleet Statistics Section -->
    <div class="container mt-5">
        <h2>Fleet 22 Statistics</h2>
        <ul>
            <li>Fleet 22 Boats: 26</li>
            <li>Active Membership: 0</li>
            <li>Total Sail Tags: 7928</li>
            <li>Boats with Sail Tags: 531</li>
            <li>Boats with Names: 638</li>
            <li>Data Generated On: 2025-03-10 00:29:09 UTC</li>
        </ul>
    </div>

    <!-- Fleet Comparison Section -->
    <div class="container mt-5">
        <h2>Fleet Comparison</h2>
        <div class="row">
            <div class="col-md-6 chart">
                <canvas id="boatCountComparisonChart"></canvas>
            </div>
            <div class="col-md-6 chart">
                <canvas id="averageSailTagsChart"></canvas>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 chart">
                <canvas id="membershipStatusChart"></canvas>
            </div>
            <div class="col-md-6 chart">
                <canvas id="sailmakerPreferenceChart"></canvas>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 chart">
                <canvas id="ageDistributionChart"></canvas>
            </div>
            <div class="col-md-6 chart">
                <div id="geographicDistributionMap" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="site-footer">
        <div class="container">
            <div class="contact-info">
                <h3>Contact Us</h3>
                <p>Email: <a href="mailto:info@fleet22.us">info@fleet22.us</a></p>
            </div>
            <div class="copyright">
                <p>&copy; 2025 Fleet 22 Lake Erie. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.0.0/dist/chartjs-chart-matrix.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch data from JSON file
            fetch('../data/fleet_statistics.json')
                .then(response => response.json())
                .then(data => {
                    // Fleet 22 Boats Chart
                    const fleet22BoatsCtx = document.getElementById('fleet22BoatsChart').getContext('2d');
                    new Chart(fleet22BoatsCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Fleet 22 Boats'],
                            datasets: [{
                                label: 'Number of Boats',
                                data: [data.fleet_22_boats],
                                backgroundColor: '#28a745',
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Fleet 22 Boats'
                                }
                            }
                        }
                    });

                    // Sail Tags Chart
                    const sailTagsCtx = document.getElementById('sailTagsChart').getContext('2d');
                    new Chart(sailTagsCtx, {
                        type: 'pie',
                        data: {
                            labels: ['Total Sail Tags', 'Boats with Sail Tags'],
                            datasets: [{
                                data: [data.total_sail_tags, data.boats_with_sail_tags],
                                backgroundColor: ['#ffc107', '#17a2b8'],
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Total Sail Tags vs Boats with Sail Tags'
                                }
                            }
                        }
                    });

                    // Boats with Names Chart
                    const boatsWithNamesCtx = document.getElementById('boatsWithNamesChart').getContext('2d');
                    new Chart(boatsWithNamesCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Boats with Names'],
                            datasets: [{
                                label: 'Number of Boats',
                                data: [data.boats_with_names],
                                backgroundColor: '#dc3545',
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Boats with Names'
                                }
                            }
                        }
                    });
                });

            // Fetch both sail tags data and combined fleet data
            Promise.all([
                fetch('../data/sail_tags.json').then(response => response.json()),
                fetch('../data/combined_fleet_data.json').then(response => response.json())
            ]).then(([sailTagsData, combinedFleetData]) => {
                // Create a map of hull numbers to boat info from combined_fleet_data
                const boatInfoMap = new Map();
                combinedFleetData.forEach(boat => {
                    boatInfoMap.set(boat.hull_number, {
                        name: boat.boat_name,
                        fleet: boat.fleet
                    });
                });

                const fleetSelector = document.getElementById('fleetSelector');
                const hullSelector = document.getElementById('hullSelector');
                const showAllHeatmaps = document.getElementById('showAllHeatmaps');
                const selectedHeatmapContainer = document.getElementById('selectedHeatmapContainer');
                const allHeatmapsContainer = document.getElementById('allHeatmapsContainer');
                
                // Function to populate hull selector based on selected fleet
                function populateHullSelector(fleetFilter = 'all') {
                    // Clear existing options
                    hullSelector.innerHTML = '<option selected value="">Choose a hull...</option>';
                    
                    // Get unique hulls, filtered by fleet if needed
                    let hulls = [...new Set(sailTagsData.map(item => item.Hull))];
                    
                    if (fleetFilter !== 'all') {
                        hulls = hulls.filter(hull => {
                            const boatInfo = boatInfoMap.get(hull);
                            return boatInfo && boatInfo.fleet === fleetFilter;
                        });
                    }
                    
                    // Sort hulls numerically
                    hulls.sort((a, b) => parseInt(a) - parseInt(b));
                    
                    // Add options to the selector
                    hulls.forEach(hull => {
                        const boatInfo = boatInfoMap.get(hull);
                        let optionText = `Hull ${hull}`;
                        
                        if (boatInfo && boatInfo.name) {
                            optionText += ` - ${boatInfo.name}`;
                        }
                        
                        const option = document.createElement('option');
                        option.value = hull;
                        option.textContent = optionText;
                        hullSelector.appendChild(option);
                    });
                }

                // Create heatmap for a specific hull
                function createHeatmap(hull, container) {
                    // Clear the container first
                    container.innerHTML = '';

                    const hullData = sailTagsData.filter(item => item.Hull === hull);
                    const boatInfo = boatInfoMap.get(hull);
                    
                    if (hullData.length === 0) {
                        const noDataDiv = document.createElement('div');
                        noDataDiv.className = 'col-12 text-center alert alert-info';
                        noDataDiv.textContent = `No sail purchase data available for Hull ${hull}`;
                        container.appendChild(noDataDiv);
                        return;
                    }

                    const years = [...new Set(hullData
                        .filter(item => item['Delivery Date'])
                        .map(item => new Date(item['Delivery Date']).getFullYear()))
                    ].sort();
                    
                    const sailTypes = [...new Set(hullData
                        .filter(item => item['Sail Type'] && item['Sailmaker'])
                        .map(item => item['Sail Type'] + ' ' + item['Sailmaker']))
                    ];

                    // Skip hulls with no sail purchase data
                    if (years.length === 0 || sailTypes.length === 0) {
                        const noDataDiv = document.createElement('div');
                        noDataDiv.className = 'col-12 text-center alert alert-info';
                        noDataDiv.textContent = `No valid sail purchase data available for Hull ${hull}`;
                        container.appendChild(noDataDiv);
                        return;
                    }

                    const heatmapData = sailTypes.map(sailType => {
                        return years.map(year => {
                            return hullData.filter(item => 
                                item['Sail Type'] + ' ' + item['Sailmaker'] === sailType && 
                                item['Delivery Date'] && new Date(item['Delivery Date']).getFullYear() === year
                            ).length;
                        });
                    });

                    // Create a column for the heatmap with proper responsive sizing
                    const colDiv = document.createElement('div');
                    // Set column width based on container (single heatmap vs. all heatmaps view)
                    if (container === selectedHeatmapContainer) {
                        colDiv.className = 'col-12'; // Full width for single heatmap view
                    } else {
                        colDiv.className = 'col-md-6 col-lg-4 mb-4'; // Grid for multiple heatmaps
                    }
                    
                    // Create a card for the heatmap
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card h-100'; // Added h-100 to make cards of equal height
                    
                    // Create a card header for the hull number and boat info
                    const cardHeader = document.createElement('div');
                    cardHeader.className = 'card-header';
                    
                    let headerText = `Hull ${hull}`;
                    if (boatInfo) {
                        if (boatInfo.name) {
                            headerText += ` - ${boatInfo.name}`;
                        }
                        if (boatInfo.fleet) {
                            headerText += ` - Fleet ${boatInfo.fleet}`;
                        }
                    }
                    headerText += " - Sail Purchases";
                    
                    cardHeader.textContent = headerText;
                    cardDiv.appendChild(cardHeader);
                    
                    // Create a card body for the heatmap table
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    
                    // Create a responsive table wrapper
                    const tableWrapper = document.createElement('div');
                    tableWrapper.className = 'table-responsive';
                    
                    // Create the table for the heatmap
                    const table = document.createElement('table');
                    table.className = 'table table-bordered table-sm';
                    table.style.width = '100%'; // Ensure table fills the container

                    // Create the table header with years
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    headerRow.appendChild(document.createElement('th'));
                    years.forEach(year => {
                        const th = document.createElement('th');
                        th.textContent = year;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    // Create the table body with sail types and counts
                    const tbody = document.createElement('tbody');
                    sailTypes.forEach((sailType, rowIndex) => {
                        const row = document.createElement('tr');
                        const th = document.createElement('th');
                        th.textContent = sailType;
                        row.appendChild(th);
                        
                        // Find the maximum value for color scaling
                        const maxValue = Math.max(...heatmapData.flat());
                        
                        heatmapData[rowIndex].forEach(value => {
                            const td = document.createElement('td');
                            td.textContent = value;
                            
                            // Color the cell based on the value (0 - white, max - deep blue)
                            if (value > 0) {
                                const intensity = Math.max(0.2, value / maxValue); // Min intensity of 0.2 for visibility
                                td.style.backgroundColor = `rgba(0, 123, 255, ${intensity})`;
                                td.style.color = intensity > 0.6 ? 'white' : 'black'; // Text color based on background intensity
                            }
                            
                            row.appendChild(td);
                        });
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);

                    // Add the table to the wrapper, wrapper to card body
                    tableWrapper.appendChild(table);
                    cardBody.appendChild(tableWrapper);
                    cardDiv.appendChild(cardBody);
                    
                    // Add the card to the column
                    colDiv.appendChild(cardDiv);
                    
                    // Add the column to the container
                    container.appendChild(colDiv);
                }

                // Initialize the hull selector with all hulls
                populateHullSelector();

                // Handle fleet selection
                fleetSelector.addEventListener('change', function() {
                    populateHullSelector(this.value);
                    // Clear the selected hull and heatmap
                    hullSelector.value = '';
                    selectedHeatmapContainer.innerHTML = '';
                    selectedHeatmapContainer.style.display = 'none';
                    // Reset the "show all" checkbox
                    showAllHeatmaps.checked = false;
                    allHeatmapsContainer.style.display = 'none';
                    allHeatmapsContainer.innerHTML = '';
                });

                // Handle hull selection
                hullSelector.addEventListener('change', function() {
                    if (this.value) {
                        // If "Show all" is enabled, disable it when a specific hull is selected
                        if (showAllHeatmaps.checked) {
                            showAllHeatmaps.checked = false;
                            allHeatmapsContainer.style.display = 'none';
                        }
                        createHeatmap(this.value, selectedHeatmapContainer);
                        selectedHeatmapContainer.style.display = 'flex';
                    } else {
                        selectedHeatmapContainer.innerHTML = '';
                        selectedHeatmapContainer.style.display = 'none';
                    }
                });

                // Handle toggle for showing all heatmaps
                showAllHeatmaps.addEventListener('change', function() {
                    if (this.checked) {
                        // Clear any selected hull's heatmap
                        selectedHeatmapContainer.style.display = 'none';
                        
                        // Generate all heatmaps
                        allHeatmapsContainer.innerHTML = ''; // Always regenerate to ensure fresh data
                        
                        const fleetFilter = fleetSelector.value;
                        let hulls = [...new Set(sailTagsData.map(item => item.Hull))];
                        
                        if (fleetFilter !== 'all') {
                            hulls = hulls.filter(hull => {
                                const boatInfo = boatInfoMap.get(hull);
                                return boatInfo && boatInfo.fleet === fleetFilter;
                            });
                        }
                        
                        // Sort hulls numerically
                        hulls.sort((a, b) => parseInt(a) - parseInt(b));
                        
                        // Create a container for the message
                        const messageContainer = document.createElement('div');
                        messageContainer.className = 'col-12 mb-4';
                        allHeatmapsContainer.appendChild(messageContainer);
                        
                        // Limit to a reasonable number of hulls to avoid browser performance issues
                        if (hulls.length > 24) {
                            const limitMsg = document.createElement('div');
                            limitMsg.className = 'alert alert-warning text-center';
                            limitMsg.textContent = `Showing first 24 hulls of ${hulls.length} total. Please use the hull selector for specific hulls.`;
                            messageContainer.appendChild(limitMsg);
                            hulls = hulls.slice(0, 24);
                        } else {
                            const countMsg = document.createElement('div');
                            countMsg.className = 'alert alert-info text-center';
                            countMsg.textContent = `Displaying all ${hulls.length} hulls with sail purchase data.`;
                            messageContainer.appendChild(countMsg);
                        }
                        
                        // Create a grid container for the heatmaps
                        const heatmapsGrid = document.createElement('div');
                        heatmapsGrid.className = 'heatmaps-grid';
                        allHeatmapsContainer.appendChild(heatmapsGrid);
                        
                        // Create heatmaps for each hull
                        hulls.forEach(hull => {
                            // Create a wrapper div for the heatmap (will become a grid item)
                            const heatmapWrapper = document.createElement('div');
                            heatmapWrapper.className = 'heatmap-wrapper';
                            heatmapsGrid.appendChild(heatmapWrapper);
                            
                            // Create the heatmap inside this wrapper
                            createHeatmap(hull, heatmapWrapper);
                        });
                        
                        allHeatmapsContainer.style.display = 'block';
                        hullSelector.disabled = true;
                    } else {
                        allHeatmapsContainer.style.display = 'none';
                        hullSelector.disabled = false;
                        if (hullSelector.value) {
                            selectedHeatmapContainer.style.display = 'flex';
                        }
                    }
                });
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch data from JSON file
            fetch('../data/combined_fleet_data.json')
                .then(response => response.json())
                .then(data => {
                    const fleetData = data;
                    const fleetNames = [...new Set(fleetData.map(boat => boat.fleet))].filter(fleet => fleet !== '0');

                    // Boat count comparison across major fleets
                    const boatCounts = fleetNames.map(fleet => fleetData.filter(boat => boat.fleet === fleet).length);
                    const boatCountComparisonCtx = document.getElementById('boatCountComparisonChart').getContext('2d');
                    new Chart(boatCountComparisonCtx, {
                        type: 'bar',
                        data: {
                            labels: fleetNames,
                            datasets: [{
                                label: 'Number of Boats',
                                data: boatCounts,
                                backgroundColor: '#28a745',
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Boat Count Comparison Across Fleets'
                                }
                            }
                        }
                    });

                    // Average sail tags per boat by fleet
                    const averageSailTags = fleetNames.map(fleet => {
                        const boatsInFleet = fleetData.filter(boat => boat.fleet === fleet);
                        const totalSailTags = boatsInFleet.reduce((sum, boat) => sum + boat.sail_tags.length, 0);
                        return totalSailTags / boatsInFleet.length;
                    });
                    const averageSailTagsCtx = document.getElementById('averageSailTagsChart').getContext('2d');
                    new Chart(averageSailTagsCtx, {
                        type: 'bar',
                        data: {
                            labels: fleetNames,
                            datasets: [{
                                label: 'Average Sail Tags per Boat',
                                data: averageSailTags,
                                backgroundColor: '#ffc107',
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Average Sail Tags per Boat by Fleet'
                                }
                            }
                        }
                    });

                    // Membership status comparison between fleets
                    const membershipStatus = fleetNames.map(fleet => {
                        const boatsInFleet = fleetData.filter(boat => boat.fleet === fleet);
                        const activeMembers = boatsInFleet.filter(boat => boat.class_membership.toLowerCase().includes('member')).length;
                        return activeMembers / boatsInFleet.length * 100;
                    });
                    const membershipStatusCtx = document.getElementById('membershipStatusChart').getContext('2d');
                    new Chart(membershipStatusCtx, {
                        type: 'bar',
                        data: {
                            labels: fleetNames,
                            datasets: [{
                                label: 'Active Membership (%)',
                                data: membershipStatus,
                                backgroundColor: '#17a2b8',
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Membership Status Comparison Between Fleets'
                                }
                            }
                        }
                    });

                    // Sailmaker preference analytics by fleet
                    const sailmakerPreferences = fleetNames.map(fleet => {
                        const boatsInFleet = fleetData.filter(boat => boat.fleet === fleet);
                        const sailmakers = {};
                        boatsInFleet.forEach(boat => {
                            boat.sail_tags.forEach(tag => {
                                if (!sailmakers[tag.sailmaker]) sailmakers[tag.sailmaker] = 0;
                                sailmakers[tag.sailmaker]++;
                            });
                        });
                        return sailmakers;
                    });
                    const sailmakerPreferenceCtx = document.getElementById('sailmakerPreferenceChart').getContext('2d');
                    new Chart(sailmakerPreferenceCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(sailmakerPreferences[0]),
                            datasets: sailmakerPreferences.map((prefs, index) => ({
                                label: fleetNames[index],
                                data: Object.values(prefs),
                                backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56', '#4bc0c0'],
                            }))
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Sailmaker Preference Analytics by Fleet'
                                }
                            }
                        }
                    });

                    // Age distribution of boats by fleet
                    const ageDistribution = fleetNames.map(fleet => {
                        const boatsInFleet = fleetData.filter(boat => boat.fleet === fleet);
                        const currentYear = new Date().getFullYear();
                        return boatsInFleet.map(boat => currentYear - parseInt(boat.hull_number));
                    });
                    const ageDistributionCtx = document.getElementById('ageDistributionChart').getContext('2d');
                    new Chart(ageDistributionCtx, {
                        type: 'line',
                        data: {
                            labels: fleetNames,
                            datasets: ageDistribution.map((ages, index) => ({
                                label: fleetNames[index],
                                data: ages,
                                fill: false,
                                borderColor: '#'+(Math.random()*0xFFFFFF<<0).toString(16),
                            }))
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Age Distribution of Boats by Fleet'
                                }
                            }
                        }
                    });

                    // Geographic distribution map of fleets
                    const map = L.map('geographicDistributionMap').setView([37.8, -96], 4);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                    fleetData.forEach(boat => {
                        if (boat.latitude && boat.longitude) {
                            L.marker([boat.latitude, boat.longitude]).addTo(map)
                                .bindPopup(`<b>${boat.boat_name}</b><br>Fleet: ${boat.fleet}`);
                        }
                    });
                });
        });
    </script>
</body>
</html>