<!DOCTYPE html>
<html>
<head>
    <title>GitHub Style Heatmap Example</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap/cal-heatmap.css" />
    <script src="https://cdn.jsdelivr.net/npm/d3@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap/cal-heatmap.min.js"></script>
</head>
<body>
    <div id="controls">
        <button id="prev-year">Previous Year</button>
        <span id="current-year"></span>
        <button id="next-year">Next Year</button>
    </div>
    <div id="cal-heatmap"></div>

    <script>
        let currentYear = new Date().getFullYear() - 1; // Start with the last complete year
        let cal = new CalHeatMap(); // Define cal at a wider scope so it can be destroyed and recreated

        // Fetch the JSON data
        fetch('sail_tags.json')
            .then(response => response.json())
            .then(data => {
                globalData = transformData(data); // Transform and store the data globally
                initializeHeatmap(currentYear, globalData); // Initialize heatmap with last year's data
            })
            .catch(error => console.error('Error loading the JSON data:', error));

        // Initialize heatmap function
        function initializeHeatmap(year, data) {
            // Update the current year display
            document.getElementById('current-year').textContent = year;
            // Initialize CalHeatMap
            cal.init({
                itemSelector: "#cal-heatmap",
                domain: "year",
                subDomain: "day",
                data: data,
                start: new Date(year, 0),
                cellSize: 10,
                range: 12,
                legend: [1, 2, 4, 8, 16],
                tooltip: true
            });
        }

        // Utility function to transform the data into the format CalHeatmap expects
        function transformData(data) {
            const transformedData = {};
            data.forEach(item => {
                if (item['Delivery Date']) {
                    const date = new Date(item['Delivery Date']);
                    if (!isNaN(date.getTime())) {
                        const timestamp = Math.floor(date.getTime() / 1000);
                        transformedData[timestamp] = (transformedData[timestamp] || 0) + 1;
                    }
                }
            });
            return transformedData;
        }

        // Function to update the heatmap display with the given year's data
        function updateHeatmapDisplay(year, data) {
            document.getElementById('current-year').textContent = year;
            document.getElementById('cal-heatmap').innerHTML = ''; // Clear the existing heatmap
            cal = new CalHeatMap(); // Create a new instance
            initializeHeatmap(year, data); // Initialize the new instance
        }

        // Navigation buttons
        document.getElementById('prev-year').addEventListener('click', function () {
            currentYear--;
            const yearData = filterDataByYear(globalData, currentYear);
            updateHeatmapDisplay(currentYear, yearData);
        });

        document.getElementById('next-year').addEventListener('click', function () {
            currentYear++;
            const yearData = filterDataByYear(globalData, currentYear);
            updateHeatmapDisplay(currentYear, yearData);
        });

        // Function to filter data by year
// Function to filter data by year
function filterDataByYear(data, year) {
    // Calculate the start and end timestamps for the given year
    const startOfYear = new Date(year, 0, 1).getTime() / 1000;
    const endOfYear = new Date(year + 1, 0, 1).getTime() / 1000 - 1; // One second before the start of the next year

    // Filter the data to include only the points within the year range
    const yearData = Object.keys(data)
        .filter(key => {
            const timestamp = parseInt(key, 10);
            return timestamp >= startOfYear && timestamp <= endOfYear;
        })
        .reduce((obj, key) => {
            obj[key] = data[key];
            return obj;
        }, {});

    return yearData;
}

        
    </script>
</body>
</html>
